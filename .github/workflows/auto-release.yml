name: ç‰ˆæœ¬æ›´æ–°

on:
  push:
    tags:
      - 'v*'  # åŒ¹é…æ‰€æœ‰ä»¥vå¼€å¤´çš„æ ‡ç­¾ï¼Œä¾‹å¦‚v1.0.0

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Node.jsç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: å®‰è£…ä¾èµ–
        run: npm install

      - name: è·å–é¡¹ç›®ç‰ˆæœ¬å·
        id: package_version
        run: |
          $version = (Get-Content -Raw -Path package.json | ConvertFrom-Json).version
          echo "APP_VERSION=$version" >> $env:GITHUB_ENV
          echo "ç‰ˆæœ¬å·: $version"

      - name: æ„å»ºåº”ç”¨ç¨‹åº
        run: npm run build:win

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: electron-app-windows
          path: |
            dist/*.exe
          retention-days: 5

  upload-to-backend:
    needs: build
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è·å–é¡¹ç›®ç‰ˆæœ¬å·å’Œæ›´æ–°ä¿¡æ¯
        id: get_info
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "APP_VERSION=$VERSION" >> $GITHUB_ENV
          echo "ç‰ˆæœ¬å·: $VERSION"
          
          # è·å–æœ€æ–°çš„æäº¤ä¿¡æ¯ä½œä¸ºæ›´æ–°å†…å®¹
          COMMIT_MESSAGE=$(git log -1 --pretty=%B)
          # é™åˆ¶é•¿åº¦å¹¶å¤„ç†ç‰¹æ®Šå­—ç¬¦
          RELEASE_NOTES=$(echo "$COMMIT_MESSAGE" | head -c 100 | tr -d '"' | tr -d "'")
          echo "RELEASE_NOTES=$RELEASE_NOTES" >> $GITHUB_ENV
          echo "æ›´æ–°ä¿¡æ¯: $RELEASE_NOTES"

      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: electron-app-windows
          path: dist

      - name: æ˜¾ç¤ºæ„å»ºäº§ç‰©ç»“æ„
        run: |
          ls -la dist/
          # è·å–exeæ–‡ä»¶å
          EXE_FILE=$(find dist/ -name "*.exe" -type f | head -n 1)
          echo "EXE_FILE=$EXE_FILE" >> $GITHUB_ENV
          echo "æ‰¾åˆ°çš„æ‰§è¡Œæ–‡ä»¶: $EXE_FILE"

      - name: ä¸Šä¼ åˆ°åç«¯æœåŠ¡å™¨
        run: |
          if [ -z "${{ env.EXE_FILE }}" ]; then
            echo "é”™è¯¯: æœªæ‰¾åˆ°exeæ–‡ä»¶"
            exit 1
          fi
          
          echo "å¼€å§‹å‡†å¤‡ä¸Šä¼ æ–‡ä»¶..."
          echo "åŸæ–‡ä»¶: ${{ env.EXE_FILE }}"
          
          # æ£€æŸ¥æ–‡ä»¶å¤§å°
          file_size=$(stat -f%z "${{ env.EXE_FILE }}" 2>/dev/null || stat -c%s "${{ env.EXE_FILE }}")
          echo "æ–‡ä»¶å¤§å°: $file_size bytes ($(($file_size / 1024 / 1024)) MB)"
          
          # å¦‚æœæ–‡ä»¶å¤§äº100MBï¼Œè¿›è¡Œå‹ç¼©
          if [ $file_size -gt 104857600 ]; then
            echo "æ–‡ä»¶è¾ƒå¤§ï¼Œæ­£åœ¨å‹ç¼©..."
            original_file="${{ env.EXE_FILE }}"
            compressed_file="${original_file}.gz"
            gzip -c "$original_file" > "$compressed_file"
            upload_file="$compressed_file"
            echo "å‹ç¼©åæ–‡ä»¶: $upload_file"
            
            # æ£€æŸ¥å‹ç¼©åå¤§å°
            compressed_size=$(stat -f%z "$compressed_file" 2>/dev/null || stat -c%s "$compressed_file")
            echo "å‹ç¼©åå¤§å°: $compressed_size bytes ($(($compressed_size / 1024 / 1024)) MB)"
          else
            upload_file="${{ env.EXE_FILE }}"
          fi
          
          echo "å¼€å§‹ä¸Šä¼ æ–‡ä»¶åˆ°åç«¯æœåŠ¡å™¨..."
          echo "æœåŠ¡å™¨åœ°å€: ${{ vars.BACKEND_SERVER_URL }}"
          echo "ç‰ˆæœ¬å·: ${{ env.APP_VERSION }}"
          echo "æ›´æ–°ä¿¡æ¯: ${{ env.RELEASE_NOTES }}"
          echo "ä¸Šä¼ æ–‡ä»¶: $upload_file"
          
          # ä½¿ç”¨curlä¸Šä¼ æ–‡ä»¶åˆ°åç«¯æ¥å£ï¼Œå¢åŠ è¶…æ—¶æ—¶é—´
          response=$(curl -s -w "%{http_code}" \
            --connect-timeout 30 \
            --max-time 600 \
            -X POST \
            -H "Authorization: ${{ secrets.BACKEND_AUTH_TOKEN }}" \
            -F "appFile=@$upload_file" \
            -F "version=${{ env.APP_VERSION }}" \
            -F "releaseNotes=${{ env.RELEASE_NOTES }}" \
            "${{ vars.BACKEND_SERVER_URL }}/api/version/upload")
          
          http_code="${response: -3}"
          response_body="${response%???}"
          
          echo "HTTPçŠ¶æ€ç : $http_code"
          echo "å“åº”å†…å®¹: $response_body"
          
          if [ "$http_code" -eq 200 ]; then
            echo "âœ… æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼"
          else
            echo "âŒ æ–‡ä»¶ä¸Šä¼ å¤±è´¥ï¼ŒHTTPçŠ¶æ€ç : $http_code"
            echo "å“åº”å†…å®¹: $response_body"
            
            # å¦‚æœæ˜¯413é”™è¯¯ï¼Œç»™å‡ºè¯¦ç»†è¯´æ˜
            if [ "$http_code" -eq 413 ]; then
              echo ""
              echo "ğŸ“‹ 413é”™è¯¯è§£å†³æ–¹æ¡ˆï¼š"
              echo "1. æ£€æŸ¥nginxé…ç½®ä¸­çš„client_max_body_sizeè®¾ç½®"
              echo "2. ç¡®ä¿æœåŠ¡å™¨æ”¯æŒå¤§æ–‡ä»¶ä¸Šä¼ "
              echo "3. æ–‡ä»¶å¤§å°: $(($file_size / 1024 / 1024)) MB"
            fi
            
            exit 1
          fi

  publish-release:
    needs: [build, upload-to-backend]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è·å–é¡¹ç›®ç‰ˆæœ¬å·
        id: package_version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "APP_VERSION=$VERSION" >> $GITHUB_ENV
          echo "ç‰ˆæœ¬å·: $VERSION"

      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: electron-app-windows
          path: dist

      - name: æ˜¾ç¤ºæ„å»ºäº§ç‰©ç»“æ„
        run: |
          ls -la dist/

      - name: åˆ›å»ºå‘å¸ƒ
        uses: ncipollo/release-action@v1
        with:
          artifacts: "dist/*.exe"
          tag: v${{ env.APP_VERSION }}
          name: é•¿è™¹å›½é™…ç®¡ç†ä»‹é¢ v${{ env.APP_VERSION }}
          body: |
            ### ç‰ˆæœ¬ ${{ env.APP_VERSION }} å‘å¸ƒ
            æ›´æ–°å†…å®¹: æ·»åŠ è½¯ä»¶è‡ªåŠ¨æ›´æ–°åŠŸèƒ½
            å‘å¸ƒæ—¶é—´: ${{ github.event.head_commit.timestamp }}
            æäº¤: ${{ github.sha }}
            
            **æ³¨æ„**: æ­¤ç‰ˆæœ¬å·²è‡ªåŠ¨ä¸Šä¼ åˆ°æ›´æ–°æœåŠ¡å™¨ï¼Œæ”¯æŒåº”ç”¨å†…è‡ªåŠ¨æ›´æ–°ã€‚
          token: ${{ secrets.GITHUB_TOKEN }}
          allowUpdates: true
          draft: false
          prerelease: false
