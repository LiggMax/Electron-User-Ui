name: ç‰ˆæœ¬æ›´æ–°

on:
  push:
    tags:
      - 'v*'  # åŒ¹é…æ‰€æœ‰ä»¥vå¼€å¤´çš„æ ‡ç­¾ï¼Œä¾‹å¦‚v1.0.0

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Node.jsçŽ¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: å®‰è£…ä¾èµ–
        run: npm install

      - name: èŽ·å–é¡¹ç›®ç‰ˆæœ¬å·
        id: package_version
        run: |
          $version = (Get-Content -Raw -Path package.json | ConvertFrom-Json).version
          echo "APP_VERSION=$version" >> $env:GITHUB_ENV
          echo "ç‰ˆæœ¬å·: $version"

      - name: æž„å»ºåº”ç”¨ç¨‹åº
        run: npm run build:win

      - name: ä¸Šä¼ æž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: electron-app-windows
          path: |
            dist/*.exe
          retention-days: 5

  upload-to-backend:
    needs: build
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: èŽ·å–é¡¹ç›®ç‰ˆæœ¬å·å’Œæ›´æ–°ä¿¡æ¯
        id: get_info
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "APP_VERSION=$VERSION" >> $GITHUB_ENV
          echo "ç‰ˆæœ¬å·: $VERSION"
          
          # èŽ·å–æœ€æ–°çš„æäº¤ä¿¡æ¯ä½œä¸ºæ›´æ–°å†…å®¹
          COMMIT_MESSAGE=$(git log -1 --pretty=%B)
          # é™åˆ¶é•¿åº¦å¹¶å¤„ç†ç‰¹æ®Šå­—ç¬¦
          RELEASE_NOTES=$(echo "$COMMIT_MESSAGE" | head -c 100 | tr -d '"' | tr -d "'")
          echo "RELEASE_NOTES=$RELEASE_NOTES" >> $GITHUB_ENV
          echo "æ›´æ–°ä¿¡æ¯: $RELEASE_NOTES"

      - name: ä¸‹è½½æž„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: electron-app-windows
          path: dist

      - name: æ˜¾ç¤ºæž„å»ºäº§ç‰©ç»“æž„
        run: |
          ls -la dist/
          # èŽ·å–exeæ–‡ä»¶å
          EXE_FILE=$(find dist/ -name "*.exe" -type f | head -n 1)
          echo "EXE_FILE=$EXE_FILE" >> $GITHUB_ENV
          echo "æ‰¾åˆ°çš„æ‰§è¡Œæ–‡ä»¶: $EXE_FILE"

      - name: ä¸Šä¼ åˆ°åŽç«¯æœåŠ¡å™¨
        run: |
          if [ -z "${{ env.EXE_FILE }}" ]; then
            echo "é”™è¯¯: æœªæ‰¾åˆ°exeæ–‡ä»¶"
            exit 1
          fi
          
          echo "å¼€å§‹å‡†å¤‡ä¸Šä¼ æ–‡ä»¶..."
          echo "åŽŸæ–‡ä»¶: ${{ env.EXE_FILE }}"
          
          # æ£€æŸ¥æ–‡ä»¶å¤§å°
          file_size=$(stat -f%z "${{ env.EXE_FILE }}" 2>/dev/null || stat -c%s "${{ env.EXE_FILE }}")
          echo "æ–‡ä»¶å¤§å°: $file_size bytes ($(($file_size / 1024 / 1024)) MB)"
          
          # å¦‚æžœæ–‡ä»¶å¤§äºŽ100MBï¼Œè¿›è¡ŒåŽ‹ç¼©
          if [ $file_size -gt 104857600 ]; then
            echo "æ–‡ä»¶è¾ƒå¤§ï¼Œæ­£åœ¨åŽ‹ç¼©..."
            original_file="${{ env.EXE_FILE }}"
            compressed_file="${original_file}.gz"
            gzip -c "$original_file" > "$compressed_file"
            upload_file="$compressed_file"
            echo "åŽ‹ç¼©åŽæ–‡ä»¶: $upload_file"
            
            # æ£€æŸ¥åŽ‹ç¼©åŽå¤§å°
            compressed_size=$(stat -f%z "$compressed_file" 2>/dev/null || stat -c%s "$compressed_file")
            echo "åŽ‹ç¼©åŽå¤§å°: $compressed_size bytes ($(($compressed_size / 1024 / 1024)) MB)"
          else
            upload_file="${{ env.EXE_FILE }}"
          fi
          
          echo "å¼€å§‹ä¸Šä¼ æ–‡ä»¶åˆ°åŽç«¯æœåŠ¡å™¨..."
          echo "æœåŠ¡å™¨åœ°å€: ${{ vars.BACKEND_SERVER_URL }}"
          echo "ç‰ˆæœ¬å·: ${{ env.APP_VERSION }}"
          echo "æ›´æ–°ä¿¡æ¯: ${{ env.RELEASE_NOTES }}"
          echo "ä¸Šä¼ æ–‡ä»¶: $upload_file"
          
          # ä½¿ç”¨curlä¸Šä¼ æ–‡ä»¶åˆ°åŽç«¯æŽ¥å£ï¼Œå¢žåŠ è¶…æ—¶æ—¶é—´
          response=$(curl -s -w "%{http_code}" \
            --connect-timeout 30 \
            --max-time 600 \
            -X POST \
            -H "Authorization: ${{ secrets.BACKEND_AUTH_TOKEN }}" \
            -F "appFile=@$upload_file" \
            -F "app=0"\
            -F "version=${{ env.APP_VERSION }}" \
            -F "releaseNotes=${{ env.RELEASE_NOTES }}" \
            "${{ vars.BACKEND_SERVER_URL }}/api/version/upload")
          
          http_code="${response: -3}"
          response_body="${response%???}"
          
          echo "HTTPçŠ¶æ€ç : $http_code"
          echo "å“åº”å†…å®¹: $response_body"
          
          if [ "$http_code" -eq 200 ]; then
            echo "âœ… æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼"
          else
            echo "âŒ æ–‡ä»¶ä¸Šä¼ å¤±è´¥ï¼ŒHTTPçŠ¶æ€ç : $http_code"
            echo "å“åº”å†…å®¹: $response_body"
            
            # å¦‚æžœæ˜¯413é”™è¯¯ï¼Œç»™å‡ºè¯¦ç»†è¯´æ˜Ž
            if [ "$http_code" -eq 413 ]; then
              echo ""
              echo "ðŸ“‹ 413é”™è¯¯è§£å†³æ–¹æ¡ˆï¼š"
              echo "1. æ£€æŸ¥nginxé…ç½®ä¸­çš„client_max_body_sizeè®¾ç½®"
              echo "2. ç¡®ä¿æœåŠ¡å™¨æ”¯æŒå¤§æ–‡ä»¶ä¸Šä¼ "
              echo "3. æ–‡ä»¶å¤§å°: $(($file_size / 1024 / 1024)) MB"
            fi
            
            exit 1
          fi

  publish-release:
    needs: [build, upload-to-backend]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: èŽ·å–é¡¹ç›®ç‰ˆæœ¬å·å’Œå‘å¸ƒä¿¡æ¯
        id: package_version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "APP_VERSION=$VERSION" >> $GITHUB_ENV
          echo "ç‰ˆæœ¬å·: $VERSION"
          
          # èŽ·å–æœ€æ–°çš„æäº¤ä¿¡æ¯ä½œä¸ºæ›´æ–°å†…å®¹
          COMMIT_MESSAGE=$(git log -1 --pretty=%B)
          # èŽ·å–æ›´è¯¦ç»†çš„æäº¤åŽ†å²ï¼ˆè‡ªä¸Šä¸ªtagä»¥æ¥çš„å˜æ›´ï¼‰
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -n "$PREVIOUS_TAG" ]; then
            CHANGELOG=$(git log --pretty=format:"- %s" $PREVIOUS_TAG..HEAD | head -20)
          else
            CHANGELOG=$(git log --pretty=format:"- %s" --max-count=10)
          fi
          
          # ä¿å­˜åˆ°æ–‡ä»¶ä»¥é¿å…ç‰¹æ®Šå­—ç¬¦é—®é¢˜
          echo "$CHANGELOG" > CHANGELOG.txt
          echo "æ›´æ–°æ—¥å¿—å·²ä¿å­˜åˆ° CHANGELOG.txt"

      - name: ä¸‹è½½æž„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: electron-app-windows
          path: dist

      - name: æ˜¾ç¤ºæž„å»ºäº§ç‰©ç»“æž„å’Œæ–‡ä»¶ä¿¡æ¯
        run: |
          ls -la dist/
          # èŽ·å–exeæ–‡ä»¶ä¿¡æ¯
          EXE_FILE=$(find dist/ -name "*.exe" -type f | head -n 1)
          if [ -n "$EXE_FILE" ]; then
            file_size=$(stat -c%s "$EXE_FILE" 2>/dev/null || stat -f%z "$EXE_FILE")
            file_size_mb=$(( file_size / 1024 / 1024 ))
            echo "EXE_FILE=$EXE_FILE" >> $GITHUB_ENV
            echo "FILE_SIZE_MB=${file_size_mb}" >> $GITHUB_ENV
            echo "æ‰¾åˆ°çš„æ‰§è¡Œæ–‡ä»¶: $EXE_FILE (${file_size_mb} MB)"
          fi

      - name: ç”Ÿæˆå‘å¸ƒè¯´æ˜Ž
        run: |
          cat > RELEASE_BODY.md << 'EOF'
          ## ðŸ“¦ ç‰ˆæœ¬ ${{ env.APP_VERSION }} å‘å¸ƒè¯´æ˜Ž
          
          ### âœ¨ æ›´æ–°å†…å®¹
          EOF
          cat CHANGELOG.txt >> RELEASE_BODY.md
          cat >> RELEASE_BODY.md << 'EOF'
          
          ### ðŸ“‹ ç‰ˆæœ¬ä¿¡æ¯
          - **ç‰ˆæœ¬å·**: v${{ env.APP_VERSION }}
          - **å‘å¸ƒæ—¶é—´**: ${{ github.event.head_commit.timestamp }}
          - **æ–‡ä»¶å¤§å°**: ${{ env.FILE_SIZE_MB }} MB
          - **æ”¯æŒå¹³å°**: Windows 10/11 (x64)
          - **æäº¤å“ˆå¸Œ**: ${{ github.sha }}
          
          ### ðŸ”„ è‡ªåŠ¨æ›´æ–°æ”¯æŒ
          - âœ… æ”¯æŒåº”ç”¨å†…è‡ªåŠ¨æ›´æ–°
          - âœ… å·²è‡ªåŠ¨ä¸Šä¼ åˆ°æ›´æ–°æœåŠ¡å™¨
          - âœ… ç”¨æˆ·å°†æ”¶åˆ°æ›´æ–°é€šçŸ¥
          
          ### ðŸ“¥ ä¸‹è½½è¯´æ˜Ž
          1. ä¸‹è½½ä¸‹æ–¹çš„ `.exe` æ–‡ä»¶
          2. ä»¥ç®¡ç†å‘˜æƒé™è¿è¡Œå®‰è£…ç¨‹åº
          3. å¦‚æžœå·²å®‰è£…æ—§ç‰ˆæœ¬ï¼Œç¨‹åºä¼šè‡ªåŠ¨è¦†ç›–æ›´æ–°
          
          ### ðŸ› ï¸ æŠ€æœ¯æ”¯æŒ
          å¦‚æžœåœ¨å®‰è£…æˆ–ä½¿ç”¨è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œè¯·æäº¤ Issue æˆ–è”ç³»å¼€å‘å›¢é˜Ÿã€‚
          
          ---
          *æ­¤ç‰ˆæœ¬é€šè¿‡ GitHub Actions è‡ªåŠ¨æž„å»ºå’Œå‘å¸ƒ*
          EOF

      - name: åˆ›å»ºGitHubå‘å¸ƒ
        uses: ncipollo/release-action@v1
        with:
          artifacts: "dist/*.exe"
          tag: v${{ env.APP_VERSION }}
          name: "ðŸš€ v${{ env.APP_VERSION }}"
          bodyFile: "RELEASE_BODY.md"
          token: ${{ secrets.GITHUB_TOKEN }}
          allowUpdates: true
          draft: false
          prerelease: false
          generateReleaseNotes: false
          makeLatest: true
